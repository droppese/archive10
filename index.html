<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ëˆ”ì˜ ìˆ²</title> 
    
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        :root{
            --bg: #f8f9fa;
            --card: #ffffff;
            --accent: #3498db;
            --muted: #7f8c8d;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --soft-green: #aed581;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, Verdana, sans-serif;
            background-color: var(--bg); 
            margin: 0;
            padding: 20px; 
            line-height: 1.6;
            padding-bottom: 20px; 
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1000px; 
            margin: auto;
            background: var(--card); 
            padding: 25px;
            border-radius: 12px; 
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); 
            position: relative;
            min-height: auto; 
        }

        h1 {
            color: #34495e; 
            padding-bottom: 15px; 
            margin-bottom: 20px; 
            font-size: 1.8em; 
            font-weight: 600;
            cursor: pointer;
        }

        /* ========== ê²€ìƒ‰, ë²„íŠ¼ ========== */
        .search-box{position:relative;margin-bottom:16px}
        #searchInput{
            width:100%;
            padding:10px 36px;
            border:1px solid #ccc;
            border-radius:6px;
            font-size:0.95em;
            box-sizing:border-box; /* ê²€ìƒ‰ì°½ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ */
        }
        .search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);pointer-events:none}
        #clearSearchBtn{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:none;background:none;font-weight:bold;display:none;cursor:pointer}

        #buttonContainer{display:flex;justify-content:flex-end;gap:10px;margin-bottom:12px}
        button{border:none;border-radius:6px;padding:8px 12px;cursor:pointer;background:#e9ecef;color:#34495e;transition:background-color 0.1s}
        .primary{background:var(--success);color:#fff;font-weight:600}
        .accent{background:var(--warning);color:#fff;font-weight:600}
        .pill{background:#f1f3f5}
        .cancel-btn{background:#bdc3c7; color:#fff}
        
        /* ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .category-item{background:#ecf0f1;border-radius:10px;height:100px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;cursor:pointer; transition:background-color 0.1s}
        .category-item.active {
            background-color: var(--accent);
            color: white;
            font-weight: bold;
            border-color: var(--accent);
        }

        /* í˜„ì¬ ì¹´í…Œê³ ë¦¬ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        #currentCategoryDisplay {
            display: none; /* JSë¡œ ì œì–´ */
            margin-bottom: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: #eef7ff; /* ì—°í•œ íŒŒë‘ ë°°ê²½ */
            border: 1px solid var(--accent);
            border-radius: 6px;
        }
        #selectedCategoryName {
            color: var(--accent);
            font-size: 1.1em;
            font-weight: 800;
        }

        /* ========== ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ========== */
        .list-container{display:flex;flex-direction:column;gap:14px}
        .item-card{display:flex;align-items:flex-start;padding:12px;border-radius:8px;border:1px solid #ecf0f1;background:#fff;box-shadow:0 4px 8px rgba(0,0,0,0.03);cursor:pointer}
        .item-thumbnail-wrapper{width:60px;height:60px;min-width:60px;border-radius:8px;overflow:hidden;margin-right:14px;border:1px solid #bdc3c7;display:flex;align-items:center;justify-content:center;background:#ecf0f1;font-size:0.75em;color:var(--muted)}
        .item-thumbnail{width:100%;height:100%;object-fit:cover}
        .item-content{flex:1;min-width:0}
        .item-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
        .item-name{font-weight:700;color:#34495e;font-size:1.05em;max-width:70%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .item-info{font-size:0.85em;color:var(--muted)}
        .item-actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}

        /* ìƒíƒœ ìƒ‰ìƒ */
        .status-waiting{color:var(--warning);font-weight:700}
        .status-selling{color:var(--success);font-weight:700}
        .status-reserved{color:#8e44ad;font-weight:700}
        .status-completed{color:#95a5a6}
        .status-cancelled{color:var(--danger);font-weight:700}

        .detail-row{display:none;width:100%;background:#f6f8fa;padding:14px;border-radius:8px;border:1px dashed #ddd;margin-top:-6px;box-sizing:border-box}
        
        /* ë‹¤ì¤‘ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .detail-image-gallery{
            display:flex;
            overflow-x:auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
            gap:8px;
            padding:10px 0;
            border-bottom:1px solid #eee;
            margin-bottom:10px;
        }
        .detail-image-box{
            max-width:100%;
            height:auto;
            min-width:120px; /* ê° ì´ë¯¸ì§€ ìµœì†Œ ë„ˆë¹„ */
            max-height:150px;
            border-radius:8px;
            border:1px solid #ccc;
            padding:6px;
            background:#ecf0f1;
            display:flex;
            align-items:center;
            justify-content:center;
            overflow:hidden;
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
        }
        .detail-image-box img{
            max-width:100%;
            max-height:100%;
            height:auto;
            width:auto;
            object-fit:contain;
            display:block;
            border-radius:4px;
        }
        /* No Image Placeholder */
        .detail-no-image{
             height:150px;
             width:100%;
             background:#e0e0e0;
             display:flex;
             align-items:center;
             justify-content:center;
             font-weight:700;
             border-radius:8px;
             margin-bottom:10px;
        }
        
        /* item-detail-info ë‚´ ì´ë¯¸ì§€ í¬ê¸° ì œí•œ (ì‹ ì²­ í˜ì´ì§€) */
        .item-detail-info .image-container {
            flex-shrink: 0;
            width: 150px;
            height: 150px;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .item-detail-info .image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0;
        }

        /* admin footer */
        footer{position:fixed;left:0;right:0;bottom:0;display:none;background:var(--soft-green);padding:14px;text-align:center;box-shadow:0 -4px 8px rgba(0,0,0,0.12);z-index:100}
        footer button{margin:0 6px}

        /* form */
        .form-content input[type=text], .form-content select, .form-content textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
        /* info-group: 3ì¹¸ -> 2ì¹¸ìœ¼ë¡œ ë³€ê²½ (ì´ë¦„, ë¶€ì„œë§Œ ë‚¨ìŒ) */
        .info-group{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:12px;border-radius:8px;background:#eef7ff;border:1px dashed var(--accent)}

        /* category grid */
        .category-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:12px}

        /* ========== ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ========== */
        .image-modal {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            position: fixed;
            z-index: 200; /* ìµœìƒìœ„ */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9); /* ì–´ë‘ìš´ ë°°ê²½ */
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 90%;
            max-width: 700px;
            max-height: 90vh; /* í™”ë©´ ë†’ì´ì— ë§ì¶¤ */
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        /* ================================================= */


        /* responsive */
        @media(max-width:600px){
            body{padding:10px}
            .container{padding:14px}
            .category-grid{grid-template-columns:repeat(2,1fr)}
            .info-group{grid-template-columns:1fr}
            footer{flex-wrap:wrap}
            .item-detail-info {
                flex-direction: column;
                align-items: center;
            }
            .item-detail-info .image-container {
                width: 100%;
                height: 200px; /* ëª¨ë°”ì¼ì—ì„œ ì¢€ ë” í¬ê²Œ */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="headerTitle">ğŸŒ³ ë‚˜ëˆ”ì˜ ìˆ²</h1>

        <div id="mainContent">
            <div class="search-container">
                <div class="search-box">
                    <input id="searchInput" type="text" placeholder="ë¬¼í’ˆ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." />
                    <span class="search-icon">ğŸ”</span>
                    <button id="clearSearchBtn" onclick="clearSearchInput()">X</button>
                </div>
            </div>

            <div id="buttonContainer">
                <div class="action-group">
                    <button class="accent" id="categoryButton" onclick="showPage('categoryPage')">ğŸ·ï¸ ì¹´í…Œê³ ë¦¬</button>
                </div>
                <div id="registerButtonContainer" class="action-group">
                    <button class="primary" onclick="showPage('registrationFormPage')">ğŸ“¦ ë‚´ ë¬¼ê±´ ë“±ë¡í•˜ê¸°</button>
                </div>
            </div>

            <div id="currentCategoryDisplay">
                <div>
                    í˜„ì¬ ì¹´í…Œê³ ë¦¬: <span id="selectedCategoryName"></span>
                </div>
                <button class="pill" onclick="filterByCategory(null)" style="padding:6px 10px;font-weight:600">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>
            <div id="item-list-container" class="list-container"></div>
        </div>

        <div id="categoryPage" style="display:none">
            <h2>ğŸ·ï¸ ì¹´í…Œê³ ë¦¬ ì„ íƒ</h2>
            <p>ì›í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            <button class="cancel-btn" onclick="showPage('main')" style="margin-bottom:12px">ğŸ”™ ë’¤ë¡œê°€ê¸°</button>
            <div class="category-grid"></div>
        </div>

        <div id="itemDetailPage" style="display:none"></div>

        <div id="adminListPage" style="display:none">
            <h2>ğŸš¨ ê´€ë¦¬ ëª©ë¡</h2>
            <p>ì‹ ê·œ ë“±ë¡ ìŠ¹ì¸, ì‹ ì²­ ìŠ¹ì¸, ê±°ë˜ í™•ì • ë“±ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>
            <p style="color:var(--danger);font-weight:700">âœ… í˜„ì¬ ê´€ë¦¬ì ë¶€ì„œ: <span id="currentAdminDept">ë¡œê·¸ì•„ì›ƒ ìƒíƒœ</span></p>
            <button class="cancel-btn" onclick="showPage('main')" style="margin-bottom:12px">ğŸ”™ ë’¤ë¡œê°€ê¸°</button>
            <div id="adminListContainer" class="list-container"></div>
        </div>

        <div id="registrationFormPage" style="display:none">
            <h3>ë‚´ ë¬¼ê±´ ë“±ë¡í•˜ê¸°</h3>
            <div class="form-content">
                <label class="form-label">ë¬¼í’ˆ ì´ë¦„</label>
                <input type="text" id="itemName" placeholder="ë¬¼í’ˆ ì´ë¦„ (í•„ìˆ˜)" />

                <label class="form-label" style="margin-top:12px">ë“±ë¡ì ì •ë³´ (í•„ìˆ˜)</label>
                <div class="info-group">
                    <input type="text" id="requesterName" placeholder="ì´ë¦„+ì•ŒíŒŒë²³ (ì˜ˆ: ê¹€ë‚˜ëˆ”a)" />
                    <select id="requesterDept"></select>
                </div>

                <label class="form-label" style="margin-top:12px">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                <select id="itemCategory"></select>

                <label class="form-label" style="margin-top:12px">ë¬¼í’ˆ ì‚¬ì§„ íŒŒì¼ ì„ íƒ (1~3ì¥ í•„ìˆ˜, íŒŒì¼ë‹¹ ìµœëŒ€ 5MB)</label>
                <input type="file" id="itemImageFiles" accept="image/jpeg,image/jpg,image/png,image/webp" multiple />

                <label class="form-label" style="margin-top:12px">ìƒì„¸ ì„¤ëª… ë° ë‚˜ëˆ” ì¡°ê±´ (í•„ìˆ˜)</label>
                <textarea id="itemDescription" rows="6" placeholder="ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>

                <div class="form-actions" style="margin-top:12px;display:flex;gap:8px">
                    <button class="primary" onclick="addItemAsync()">ë“±ë¡ ìš”ì²­í•˜ê¸°</button>
                    <button class="cancel-btn" onclick="showPage('main')">ğŸ”™ ë’¤ë¡œê°€ê¸°</button>
                </div>
            </div>
        </div>

    </div>

    <footer>
        <button id="adminListBtn" onclick="showPage('adminListPage')" style="display:none"></button>
    </footer>

    <div id="imageModal" class="image-modal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modalImage" onclick="event.stopPropagation()">
    </div>
    <script>
        /**************************************************************************
         * ì •ë¦¬í•œ ìŠ¤í¬ë¦½íŠ¸: ë³€ìˆ˜, ì´ˆê¸° ë°ì´í„°, í—¬í¼ í•¨ìˆ˜, ë Œë”ëŸ¬, ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
         **************************************************************************/

        // --- ìƒíƒœ ---
        let isAdmin = false;
        let adminDept = null;
        let currentCategoryFilter = null;
        let currentItemId = null;

        // --- ìƒìˆ˜ ë° ìƒ˜í”Œ ë°ì´í„° ---
        const categories = ['ìœ ì•„ìš©í’ˆ','ì˜ë¥˜','ì¡í™”','ì†Œí˜•ê°€ì „','ëŒ€í˜•ê°€ì „','ê°€êµ¬','ê¸°íƒ€'];
        const categoryIcons = { 'ìœ ì•„ìš©í’ˆ':'ğŸ¼','ì˜ë¥˜':'ğŸ‘•','ì¡í™”':'ğŸ‘œ','ì†Œí˜•ê°€ì „':'ğŸ”Œ','ëŒ€í˜•ê°€ì „':'ğŸ ','ê°€êµ¬':'ğŸ›‹ï¸','ê¸°íƒ€':'ğŸ','ì „ì²´ ë³´ê¸°':'ğŸ”„' };
        
        // ğŸ› ï¸ ë¶€ì„œëª… ë³€ê²½ ì ìš©
        const departments = ['êµì—­ì', 'ìë¬¸íšŒ', 'ì¥ë…„íšŒ', 'ë¶€ë…€íšŒ', 'ì²­ë…„íšŒ', 'í•™ìƒíšŒ'];
        
        // ğŸ› ï¸ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì ìš©
        const adminPasswords = { 
            'êµì—­ì':'êµì—­ìpw',
            'ìë¬¸íšŒ':'ìë¬¸íšŒpw',
            'ì¥ë…„íšŒ':'ì¥ë…„íšŒpw',
            'ë¶€ë…€íšŒ':'ë¶€ë…€íšŒpw',
            'ì²­ë…„íšŒ':'ì²­ë…„íšŒpw',
            'í•™ìƒíšŒ':'í•™ìƒíšŒpw'
        };
        const NO_IMAGE_TEXT = 'ì´ë¯¸ì§€ ì—†ìŒ';
        const NO_IMAGE_PLACEHOLDER = 'https://via.placeholder.com/250/808080/FFFFFF?text=No+Image';
        const THUMBNAIL_PLACEHOLDER = 'https://via.placeholder.com/60/808080/FFFFFF?text=No+Img';

        // ìƒ˜í”Œ ì•„ì´í…œ (ì´ˆê¸° ë°ì´í„°) - ğŸ› ï¸ ë°ì´í„° êµ¬ì¡° ë³€ê²½: imageUrl -> imageUrls
        const items = [
            { 
                id:1, name:'ìœ ì•„ ì¹´ì‹œíŠ¸ (ISOFIX)', status:'íŒë§¤ ì¤‘', description:'ì‚¬ìš© ê¸°ê°„ 1ë…„ ë¯¸ë§Œ, ê¹¨ë—í•©ë‹ˆë‹¤.', 
                imageUrls:['https://via.placeholder.com/200/007BFF/FFFFFF?text=CarSeat_Main','https://via.placeholder.com/300/007BFF/FFFFFF?text=CarSeat_Side','https://via.placeholder.com/200/007BFF/FFFFFF?text=CarSeat_Detail'], // ë°°ì—´ë¡œ ë³€ê²½
                historyStatus:'ì‹ ì²­ ì—†ìŒ', category:'ìœ ì•„ìš©í’ˆ', requesterInfo:{name:'ê¹€ë‚˜ëˆ”',dept:'êµì—­ì',team:'',id:''}, historyBuyerInfo:null, registerDate:'2025-11-10' 
            },
            { 
                id:2, name:'ì—¬ì„±ìš© ê²¨ìš¸ ì½”íŠ¸ (90)', status:'ê±°ë˜ ì™„ë£Œ', description:'ìš¸ í˜¼ë°©, ìƒíƒœ ì–‘í˜¸', 
                imageUrls:['https://via.placeholder.com/150/8B4513/FFFFFF?text=Coat'], // ë°°ì—´ë¡œ ë³€ê²½
                historyStatus:'ê±°ë˜ í™•ì •', category:'ì˜ë¥˜', requesterInfo:{name:'ì´ìŠ¤íƒ€ì¼',dept:'ìë¬¸íšŒ',team:'',id:''}, historyBuyerInfo:{name:'í…ŒìŠ¤íŠ¸êµ¬ë§¤ì2',dept:'ì¥ë…„íšŒ',team:'',id:''}, registerDate:'2025-11-11' 
            }
            // ... ë‚˜ë¨¸ì§€ ìƒ˜í”Œì€ í•„ìš” ì‹œ ì¶”ê°€
        ];

        // ========== í—¬í¼ ==========
        
        // ğŸ› ï¸ ë³€ê²½: ì•„ì´í…œì—ì„œ í‘œì‹œí•  ì´ë¯¸ì§€ URLì„ ê°€ì ¸ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜
        function getDisplayImage(item, index = 0) {
            if (item.imageUrls && item.imageUrls.length > index && item.imageUrls[index].trim() !== '') {
                return item.imageUrls[index];
            }
            return null;
        }

        // ğŸ› ï¸ ë³€ê²½: ì•„ì´í…œì— ìœ íš¨í•œ ì´ë¯¸ì§€ URLì´ ìˆëŠ”ì§€ í™•ì¸ (ìµœì†Œ 1ì¥)
        function isValidImageUrl(item){
            return getDisplayImage(item) !== null;
        }

        function getTodayDate(){ const n=new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}` }
        function getStatusClass(status){ if(status==='ìŠ¹ì¸ ëŒ€ê¸°') return 'status-waiting'; if(status==='íŒë§¤ ì¤‘') return 'status-selling'; if(status==='ì˜ˆì•½ì¤‘') return 'status-reserved'; if(status==='ê±°ë˜ ì™„ë£Œ') return 'status-completed'; if(status==='ì·¨ì†Œë¨') return 'status-cancelled'; return '' }
        function getDisplayStatusText(internalStatus,item){ if(internalStatus==='ìŠ¹ì¸ ëŒ€ê¸°') return 'ìŠ¹ì¸ ëŒ€ê¸°'; if(internalStatus==='íŒë§¤ ì¤‘') return 'ì‹ ì²­ ê°€ëŠ¥'; if(internalStatus==='ê±°ë˜ ì™„ë£Œ') return 'ë‚˜ëˆ” ì™„ë£Œ'; if(internalStatus==='ì˜ˆì•½ì¤‘'){ if(!isAdmin) return 'ì˜ˆì•½ì¤‘'; if(item && item.historyStatus==='ì˜ˆì•½ ìŠ¹ì¸') return 'ì˜ˆì•½ í™•ì • (2ì°¨ ëŒ€ê¸°)'; if(item && item.historyStatus==='ì‹ ì²­ ì¤‘') return 'ì˜ˆì•½ ëŒ€ê¸° (1ì°¨ ëŒ€ê¸°)'; return 'ì˜ˆì•½ì¤‘' } return internalStatus }

        // ğŸ› ï¸ ë³€ê²½: íŒŒì¼ ìš©ëŸ‰ ì œí•œ (2MB -> 5MB) ë° ì—ëŸ¬ ë©”ì‹œì§€ ìˆ˜ì •
        function convertFileToBase64(file){ 
            return new Promise((resolve,reject)=>{ 
                const reader = new FileReader(); 
                const maxSize = 5*1024*1024; // 5MB
                if(file.size>maxSize){ 
                    reject(new Error('íŒŒì¼ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.')); 
                    return 
                } 
                reader.onload=()=>resolve(reader.result); 
                reader.onerror=e=>reject(e); 
                reader.readAsDataURL(file); 
            }) 
        }
        
        // ğŸ› ï¸ ì¶”ê°€: ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ ì²˜ë¦¬ í•¨ìˆ˜
        function openModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'flex'; // flexë¡œ ë³€ê²½í•˜ì—¬ ì´ë¯¸ì§€ ì¤‘ì•™ ì •ë ¬
            modalImg.src = imageUrl;
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
        // ===========================================


        // ========== ë Œë”ë§ ==========
        function renderCategoryGrid(){
            const grid = document.querySelector('#categoryPage .category-grid'); grid.innerHTML='';
            categories.forEach(cat=>{
                const div=document.createElement('div'); div.className='category-item'; div.dataset.category=cat; div.innerHTML=`<div style="font-size:1.6rem">${categoryIcons[cat]||'â“'}</div>${cat}`;
                div.onclick = ()=>{ filterByCategory(cat); showPage('main'); };
                grid.appendChild(div);
            });
            const all = document.createElement('div'); all.className='category-item'; all.dataset.category=null; all.innerHTML=`<div style="font-size:1.6rem">${categoryIcons['ì „ì²´ ë³´ê¸°']||'ğŸ”„'}</div>ì „ì²´ ë³´ê¸°`; 
            all.onclick=()=>{ filterByCategory(null); showPage('main'); }; 
            grid.appendChild(all);
            
            // ì´ˆê¸° í™œì„±í™” ìƒíƒœ ì„¤ì •
            document.querySelectorAll('.category-item').forEach(btn => {
                if (btn.dataset.category === currentCategoryFilter || (!currentCategoryFilter && btn.innerHTML.includes('ì „ì²´ ë³´ê¸°'))) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function renderCategorySelect(){ const sel = document.getElementById('itemCategory'); sel.innerHTML='<option value="">--- ì¹´í…Œê³ ë¦¬ ì„ íƒ ---</option>'; categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o) }); }
        function renderDeptSelect(elementId,defaultValue=''){ const sel = document.getElementById(elementId); if(!sel) return; sel.innerHTML=`<option value="">--- ë¶€ì„œ ì„ íƒ (í•„ìˆ˜) ---</option>`; departments.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; if(d===defaultValue) o.selected=true; sel.appendChild(o) }); }

        function renderItems(displayItems){
            const list = document.getElementById('item-list-container'); list.innerHTML='';
            let filtered = displayItems.slice();
            // ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ 'ìŠ¹ì¸ ëŒ€ê¸°'ëŠ” ìˆ¨ê¹€
            if (!isAdmin) { filtered = filtered.filter(item => item.status !== 'ìŠ¹ì¸ ëŒ€ê¸°'); }
            // ì¹´í…Œê³ ë¦¬ í•„í„° ì ìš©
            if(currentCategoryFilter) filtered = filtered.filter(i=>i.category===currentCategoryFilter);
            
            const statusOrder = {' íŒë§¤ ì¤‘':1,'ì˜ˆì•½ì¤‘':2,'ê±°ë˜ ì™„ë£Œ':3};
            filtered.sort((a,b)=> (statusOrder[a.status]||99)-(statusOrder[b.status]||99));

            if(filtered.length===0){ list.innerHTML='<p style="text-align:center;color:#777;padding:20px;margin:0">ì¡°ê±´ì— ë§ëŠ” ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return }

            filtered.forEach(item=>{
                // ğŸ› ï¸ ë³€ê²½: ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ì¸ë„¤ì¼ë¡œ ì‚¬ìš©
                const firstImageUrl = getDisplayImage(item, 0);
                const isNoImage = firstImageUrl === null;
                const displayImageUrl = isNoImage?THUMBNAIL_PLACEHOLDER:firstImageUrl;
                const thumbnailHtml = isNoImage?`<div class="item-thumbnail-wrapper">${NO_IMAGE_TEXT}</div>`:`<div class="item-thumbnail-wrapper"><img class="item-thumbnail" src="${displayImageUrl}" alt="${item.name} ì´ë¯¸ì§€"></div>`;
                
                const statusText = getDisplayStatusText(item.status,item);
                const statusClass = getStatusClass(item.status);
                let actionButton = '';
                if(!isAdmin && item.status==='íŒë§¤ ì¤‘') actionButton=`<button class="primary" onclick="showPage('itemDetailPage',${item.id})">ë‚˜ëˆ” ì‹ ì²­</button>`;
                
                // ğŸ¯ ë¶€ì„œ ì •ë³´ ë…¸ì¶œ ë° ì¤„ë°”ê¿ˆ
                let requesterInfoDisplay = `${item.requesterInfo.dept||'ë¯¸ìƒ'}`; // ë¶€ì„œëª…ë§Œ
                if(isAdmin) { requesterInfoDisplay += ` (${item.requesterInfo.name})`; } // ê´€ë¦¬ì: ë¶€ì„œ (ì´ë¦„)
                const itemInfoContent = `ì¹´í…Œê³ ë¦¬: ${item.category||'ë¯¸ë¶„ë¥˜'} | ë“±ë¡ì¼: ${item.registerDate||'-'}<br>ë“±ë¡ ë¶€ì„œ: ${requesterInfoDisplay}`;

                const card = document.createElement('div'); card.className='item-card'; card.dataset.id=item.id;
                card.innerHTML = `${thumbnailHtml}<div class="item-content"><div class="item-header"><span class="item-name" title="${item.name}">${item.name}</span><span class="item-status ${statusClass}">${statusText}</span></div><div class="item-info">${itemInfoContent}</div><div class="item-actions">${actionButton}</div></div>`;
                card.onclick = (e)=>toggleDetails(item.id,e);
                list.appendChild(card);

                const detailDiv = document.createElement('div'); detailDiv.className='detail-row'; detailDiv.id=`detail-${item.id}`;
                const formattedDescription = (item.description||'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.').replace(/\n/g,'<br>');
                
                // ğŸ› ï¸ ë³€ê²½: ë‹¤ì¤‘ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ë Œë”ë§
                let detailImageHtml = '';
                if (item.imageUrls && item.imageUrls.length > 0) {
                    detailImageHtml = '<div class="detail-image-gallery">';
                    item.imageUrls.forEach(url => {
                        if (url && url.trim() !== '') {
                             // ğŸ› ï¸ ìˆ˜ì •: ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ openModal í•¨ìˆ˜ í˜¸ì¶œ ì¶”ê°€
                             detailImageHtml += `<div class="detail-image-box"><img src="${url}" alt="${item.name} ìƒì„¸ ì´ë¯¸ì§€" onclick="openModal('${url}')"></div>`;
                        }
                    });
                    detailImageHtml += '</div>';
                } else {
                    detailImageHtml = `<div class="detail-no-image">${NO_IMAGE_TEXT}</div>`;
                }


                let requesterInfoHtml = '';
                // 'íŒ€' ì •ë³´ ì œê±° ì ìš©
                if(isAdmin){ requesterInfoHtml = `<div style="margin-top:12px"><strong>ë“±ë¡ì ì •ë³´ (ê´€ë¦¬ì ì „ìš©):</strong><br>ì´ë¦„: ${item.requesterInfo.name} | ë¶€ì„œ: ${item.requesterInfo.dept}</div>` }
                
                let deleteButtonHtml = '';
                const canDelete = isAdmin && adminDept===item.requesterInfo.dept;
                if(canDelete) deleteButtonHtml = `<button class="cancel-btn" onclick="deleteItem(${item.id})">ğŸ—‘ï¸ ë¬¼í’ˆ ì‚­ì œ (ê´€ë¦¬ì)</button>`;

                let buyerInfoHtml = '';
                // 'íŒ€' ì •ë³´ ì œê±° ì ìš©
                if(isAdmin && item.historyBuyerInfo) buyerInfoHtml = `<div style="margin-top:12px;border-top:1px dashed #ddd;padding-top:8px"><strong>ì‹ ì²­ì ì •ë³´ (ê´€ë¦¬ì ì „ìš©):</strong><br>ì´ë¦„: ${item.historyBuyerInfo.name} | ë¶€ì„œ: ${item.historyBuyerInfo.dept}</div>`;

                let editButtonHtml = '';
                const canEdit = isAdmin && adminDept===item.requesterInfo.dept;
                if(canEdit) editButtonHtml = `<button class="accent" onclick="editItem(${item.id})">âœï¸ ë¬¼í’ˆ ìˆ˜ì • (ê´€ë¦¬ì)</button>`;
                
                detailDiv.innerHTML = `<div class="detail-content">${detailImageHtml}<div style="margin-top:12px"><strong>ìƒì„¸ ì„¤ëª…:</strong><br>${formattedDescription}</div>${requesterInfoHtml}${buyerInfoHtml}<div style="margin-top:12px;text-align:right">${editButtonHtml} ${deleteButtonHtml}</div></div>`;
                list.appendChild(detailDiv);
            });
            updateAdminButtonStatus();
        }

        // ìƒì„¸ ë³´ê¸° í† ê¸€ (ë‹¨, ë²„íŠ¼ í´ë¦­ì€ ë§‰ìŒ)
        function toggleDetails(itemId,event){
            const detailDiv = document.getElementById(`detail-${itemId}`);
            const isAction = event.target.closest('.item-actions') || event.target.closest('button');
            if(isAction) return; // ë²„íŠ¼ í´ë¦­ì¼ ë•ŒëŠ” ìƒì„¸ í† ê¸€ ë°©ì§€
            if(!detailDiv) return;
            const isOpen = detailDiv.style.display==='block';
            document.querySelectorAll('.detail-row').forEach(d=>d.style.display='none');
            detailDiv.style.display = isOpen? 'none' : 'block';
        }

        // ========== í˜ì´ì§€ ì „í™˜ ==========
        function showPage(pageId,itemId=null){
            const pages = ['mainContent','registrationFormPage','adminListPage','categoryPage','itemDetailPage'];
            pages.forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display = 'none'; });
            if(pageId==='main'){ document.getElementById('mainContent').style.display='block'; searchItems(); }
            else if(pageId==='registrationFormPage'){ document.getElementById('registrationFormPage').style.display='block'; renderCategorySelect(); renderDeptSelect('requesterDept'); }
            else if(pageId==='adminListPage'){ document.getElementById('adminListPage').style.display='block'; document.getElementById('currentAdminDept').textContent = isAdmin?adminDept:'ë¡œê·¸ì•„ì›ƒ ìƒíƒœ'; renderAdminList(); }
            else if(pageId==='categoryPage'){ document.getElementById('categoryPage').style.display='block'; renderCategoryGrid(); }
            else if(pageId==='itemDetailPage'){ document.getElementById('itemDetailPage').style.display='block'; if(itemId!==null) renderItemDetailPage(itemId); }
            updateAdminButtonStatus();
        }

        // ========== ê²€ìƒ‰/í•„í„°ë§ ==========
        function searchItems(){
            const q = (document.getElementById('searchInput').value||'').trim().toLowerCase();
            const filtered = items.filter(i=> i.name.toLowerCase().includes(q));
            renderItems(filtered);
            
            // ê²€ìƒ‰ ì‹œì—ëŠ” ì¹´í…Œê³ ë¦¬ í•„í„° ì´ˆê¸°í™” (ê²€ìƒ‰ê³¼ í•„í„° ì¤‘ í•˜ë‚˜ë§Œ ì ìš©)
            currentCategoryFilter = null;
            renderCategoryGrid(); // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ì˜ í™œì„±í™” ìƒíƒœ ì´ˆê¸°í™”
            document.getElementById('currentCategoryDisplay').style.display = 'none';
        }

        function clearSearchInput(){ 
            document.getElementById('searchInput').value=''; 
            document.getElementById('clearSearchBtn').style.display='none'; 
            searchItems(); 
        }
        
        function filterByCategory(category) {
            // 1. ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';

            // 2. í•„í„° ì ìš© ë° ë Œë”ë§
            currentCategoryFilter = category;
            renderItems(items);

            // 3. í˜„ì¬ ì¹´í…Œê³ ë¦¬ í‘œì‹œ ë° ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ìš”ì²­ì‚¬í•­ ë°˜ì˜)
            const display = document.getElementById('currentCategoryDisplay');
            const nameSpan = document.getElementById('selectedCategoryName');
            
            if (category) {
                // ì¹´í…Œê³ ë¦¬ê°€ ì„ íƒëœ ê²½ìš° í‘œì‹œ
                display.style.display = 'flex'; 
                nameSpan.textContent = category;
            } else {
                // í•„í„°ê°€ í•´ì œëœ ê²½ìš° ìˆ¨ê¹€
                display.style.display = 'none';
                nameSpan.textContent = '';
            }
            renderCategoryGrid();
        }

        // ========== ê´€ë¦¬ì ë¡œê·¸ì¸ (í—¤ë” 3íšŒ í´ë¦­) ==========
        let headerClickCount=0,lastClickTime=0,TIMEOUT_MS=1000;
        document.getElementById('headerTitle').addEventListener('click',()=>{
            if(isAdmin) return; const now=Date.now(); if(now-lastClickTime>TIMEOUT_MS) headerClickCount=1; else headerClickCount++; lastClickTime=now; if(headerClickCount===3){ headerClickCount=0; loginAdmin(); }
        });

        function loginAdmin(){
            const dept = prompt('ê´€ë¦¬ì ë¡œê·¸ì¸ - ë¶€ì„œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: êµì—­ì, ìë¬¸íšŒ ë“±)'); if(!dept) return; // ğŸ› ï¸ ë¶€ì„œëª… í”„ë¡¬í”„íŠ¸ ë³€ê²½
            if(!adminPasswords[dept]){ alert('ì•Œ ìˆ˜ ì—†ëŠ” ë¶€ì„œì…ë‹ˆë‹¤.'); return; }
            const pw = prompt(`${dept} ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”`); if(pw===null) return;
            if(pw === adminPasswords[dept]){ isAdmin=true; adminDept=dept; alert(`ê´€ë¦¬ì(${adminDept})ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`); showPage('main'); }
            else{ alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); }
        }
        function logoutAdmin(){ isAdmin=false; adminDept=null; alert('ê´€ë¦¬ìì—ì„œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.'); showPage('main'); }

        // ========== ê´€ë¦¬ì ê´€ë ¨ ì•¡ì…˜ ==========
        function checkAdminAuth(item,actionType){ if(!isAdmin) return false; if(actionType==='register_approve' || actionType==='delete' || actionType==='edit') return adminDept===item.requesterInfo.dept; if(actionType==='trade_approve') return adminDept===item.requesterInfo.dept; if(actionType==='trade_confirm'){ if(!item.historyBuyerInfo) return false; return adminDept===item.historyBuyerInfo.dept } return false }

        function renderAdminList(){ 
            if(!isAdmin) return; 
            const list = document.getElementById('adminListContainer'); list.innerHTML=''; 
            const adminItems = items.filter(i=> i.status==='ìŠ¹ì¸ ëŒ€ê¸°' || i.status==='ì˜ˆì•½ì¤‘'); 
            
            if(adminItems.length===0){ 
                list.innerHTML='<p style="text-align:center;color:#555;padding:20px;margin:0">í˜„ì¬ ê´€ë¦¬ ëŒ€ê¸° ì¤‘ì¸ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>'; 
                return 
            }
            
            adminItems.forEach(item=>{
                let displayStatus=''; let actions='';
                const canApproveRegister = checkAdminAuth(item,'register_approve');
                const canApproveTrade = checkAdminAuth(item,'trade_approve');
                const canConfirmTrade = checkAdminAuth(item,'trade_confirm');

                if(item.status==='ìŠ¹ì¸ ëŒ€ê¸°'){ 
                    displayStatus='ë“±ë¡ ìŠ¹ì¸ ëŒ€ê¸°'; 
                    const reqDept=item.requesterInfo.dept; 
                    if(canApproveRegister) actions = `<button class="primary" onclick="approveItem(${item.id})">âœ… ë“±ë¡ ìŠ¹ì¸</button> <button class="cancel-btn" onclick="deleteItem(${item.id})">âŒ ì‚­ì œ</button>`; 
                    else actions=`<button class="pill disabled">ê¶Œí•œ ì—†ìŒ (ë‹´ë‹¹: ${reqDept})</button>` 
                }
                else if(item.status==='ì˜ˆì•½ì¤‘'){
                    if(item.historyStatus==='ì‹ ì²­ ì¤‘'){ 
                        displayStatus='1ì°¨ ëŒ€ê¸° (ì‹ ì²­ ìŠ¹ì¸)'; 
                        const reqDept=item.requesterInfo.dept; 
                        if(canApproveTrade) actions=`<button class="primary" onclick="approveTrade(${item.id})">âœ… 1ì°¨ ì‹ ì²­ ìŠ¹ì¸</button> <button class="cancel-btn" onclick="cancelTradeByAdmin(${item.id})">âŒ ì‹ ì²­ ê±°ì ˆ</button>`; 
                        else actions=`<button class="pill disabled">ê¶Œí•œ ì—†ìŒ (ë‹´ë‹¹: ${reqDept})</button>` 
                    }
                    else if(item.historyStatus==='ì˜ˆì•½ ìŠ¹ì¸'){ 
                        displayStatus='2ì°¨ ëŒ€ê¸° (ê±°ë˜ ì™„ë£Œ)'; 
                        const reqDept = item.historyBuyerInfo?item.historyBuyerInfo.dept:'ì‹ ì²­ì ì—†ìŒ'; 
                        if(canConfirmTrade) actions=`<button class="primary" onclick="confirmTrade(${item.id})">ğŸ“¦ 2ì°¨ ê±°ë˜ ì™„ë£Œ</button> <button class="cancel-btn" onclick="cancelTradeByAdmin(${item.id})">ğŸš« ì˜ˆì•½ ì·¨ì†Œ</button>`; 
                        else actions=`<button class="pill disabled">ê¶Œí•œ ì—†ìŒ (ë‹´ë‹¹: ${reqDept})</button>` 
                    }
                    else displayStatus='ì˜ˆì•½ì¤‘ (ìƒíƒœ ì˜¤ë¥˜)';
                }

                // ğŸ› ï¸ ë³€ê²½: ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ì¸ë„¤ì¼ë¡œ ì‚¬ìš©
                const firstImageUrl = getDisplayImage(item, 0);
                const isNoImage = firstImageUrl === null;
                const displayImageUrl = isNoImage?THUMBNAIL_PLACEHOLDER:firstImageUrl;
                const thumb = isNoImage?`<div class="item-thumbnail-wrapper">${NO_IMAGE_TEXT}</div>`:`<div class="item-thumbnail-wrapper"><img class="item-thumbnail" src="${displayImageUrl}" alt="${item.name}"></div>`;
                
                const card = document.createElement('div'); card.className='item-card admin-card'; card.style.cursor='default';

                // ì‹ ì²­ì ì •ë³´ ì¶”ê°€ ë¡œì§ (íŒ€ ì •ë³´ ì œê±°)
                let applicantInfoHtml = '';
                if (item.status === 'ì˜ˆì•½ì¤‘' && item.historyBuyerInfo) {
                    const buyer = item.historyBuyerInfo;
                    applicantInfoHtml = `<div style="margin-top:4px;font-size:0.9em;color:var(--accent)"><strong>ì‹ ì²­ ë¶€ì„œ:</strong> ${buyer.dept} | ì‹ ì²­ì: ${buyer.name}</div>`;
                }

                // ë“±ë¡ì ì •ë³´ì—ì„œ 'íŒ€' ì œê±°
                card.innerHTML = `${thumb}<div class="item-content"><div class="item-header"><span class="item-name">${item.name}</span><span class="item-status ${getStatusClass(item.status)}">${displayStatus}</span></div><div class="item-info">ì¹´í…Œê³ ë¦¬: ${item.category||'ë¯¸ë¶„ë¥˜'} | ë“±ë¡ì¼: ${item.registerDate||'-'}</div><div style="margin-top:6px;font-size:0.9em"><strong>ë“±ë¡ ë¶€ì„œ:</strong> ${item.requesterInfo.dept} | ë“±ë¡ì: ${item.requesterInfo.name}</div>${applicantInfoHtml}<div style="margin-top:8px" class="item-actions">${actions}</div></div>`;
                list.appendChild(card);
            })
        }

        function updateAdminButtonStatus(){
            const footer = document.querySelector('footer'); const adminListBtn = document.getElementById('adminListBtn'); const existingLogout = document.getElementById('dynamicLogoutBtn'); if(existingLogout) existingLogout.remove();
            const adminPageVisible = document.getElementById('adminListPage').style.display !== 'none'; const registrationVisible = document.getElementById('registrationFormPage').style.display !== 'none';
            if(isAdmin){ footer.style.display='flex'; if(!adminPageVisible && !registrationVisible){ const adminCount = items.filter(i=> i.status==='ìŠ¹ì¸ ëŒ€ê¸°' || i.status==='ì˜ˆì•½ì¤‘').length; adminListBtn.style.display='inline-block'; adminListBtn.textContent = `ğŸš¨ ê´€ë¦¬ ëª©ë¡ (${adminCount}ê±´) [${adminDept}]`; const logoutBtn=document.createElement('button'); logoutBtn.id='dynamicLogoutBtn'; logoutBtn.textContent='ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ'; logoutBtn.onclick = logoutAdmin; footer.appendChild(adminListBtn); footer.appendChild(logoutBtn);
                } else { adminListBtn.style.display='none'; const logoutBtn=document.createElement('button'); logoutBtn.id='dynamicLogoutBtn'; logoutBtn.textContent=`ë¡œê·¸ì•„ì›ƒ (${adminDept})`; logoutBtn.onclick = logoutAdmin; footer.appendChild(logoutBtn); }
            } else { footer.style.display='none'; adminListBtn.style.display='none'; }
        }

        function editItem(itemId) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;
            if (!checkAdminAuth(item, 'edit')) { alert('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

            const newName = prompt(`[${item.name}]ì˜ ìƒˆ ë¬¼í’ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬: ${item.name}):`, item.name);
            if (newName === null) return;
            const newDescription = prompt(`[${item.name}]ì˜ ìƒˆ ìƒì„¸ ì„¤ëª… (í˜„ì¬: ${item.description.substring(0, 20)}...):`, item.description);
            if (newDescription === null) return;
            const newCategory = prompt(`[${item.name}]ì˜ ìƒˆ ì¹´í…Œê³ ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬: ${item.category}).\nì„ íƒ ê°€ëŠ¥: ${categories.join(', ')}`, item.category);
            if (newCategory === null) return;
            if (!categories.includes(newCategory.trim())) { alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤. ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ê°€ ìœ ì§€ë©ë‹ˆë‹¤.'); return; }

            const newRName = prompt(`[${item.name}] ë“±ë¡ì ì´ë¦„ (í˜„ì¬: ${item.requesterInfo.name}):`, item.requesterInfo.name);
            if (newRName === null) return;

            // ë¶€ì„œ ë³€ê²½ ë¡œì§ 
            let newRDept = item.requesterInfo.dept;
            // ğŸ› ï¸ ë¶€ì„œëª… ëª©ë¡ ë³€ê²½ ì ìš©
            const deptPrompt = `[${item.name}] ë“±ë¡ì ë¶€ì„œ (í˜„ì¬: ${item.requesterInfo.dept})\n\nì„ íƒ ê°€ëŠ¥í•œ ë¶€ì„œ: ${departments.join(', ')}\nìƒˆ ë¶€ì„œë¥¼ ì…ë ¥í•˜ì„¸ìš”:`;
            let inputDept = prompt(deptPrompt, item.requesterInfo.dept);

            if (inputDept === null) return;
            if (departments.includes(inputDept.trim())) {
                 newRDept = inputDept.trim();
            } else {
                 alert('ìœ íš¨í•˜ì§€ ì•Šì€ ë¶€ì„œì…ë‹ˆë‹¤. ê¸°ì¡´ ë¶€ì„œê°€ ìœ ì§€ë©ë‹ˆë‹¤.');
            }
            
            // ğŸ› ï¸ ë³€ê²½: ì´ë¯¸ì§€ ë°°ì—´ì„ ë‹¤ë£¨ê¸° ë³µì¡í•˜ë¯€ë¡œ, ìˆ˜ì • ì‹œì—ëŠ” 'ëŒ€í‘œ ì´ë¯¸ì§€ URL'ì„ ìƒˆë¡œ ì…ë ¥ ë°›ê±°ë‚˜ ê¸°ì¡´ ê²ƒì„ ìœ ì§€í•˜ë„ë¡ ë‹¨ìˆœí™”í•©ë‹ˆë‹¤.
            const currentMainImageUrl = getDisplayImage(item, 0) || 'ì—†ìŒ';
            const newMainImageUrl = prompt(`[${item.name}]ì˜ ìƒˆ ëŒ€í‘œ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬: ${currentMainImageUrl}).\në³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ 'ìœ ì§€'ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`, currentMainImageUrl);
            
            if (newMainImageUrl === null) return;

            // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
            item.name = newName.trim();
            item.description = newDescription.trim();
            item.category = newCategory.trim();
            item.requesterInfo.name = newRName.trim();
            item.requesterInfo.dept = newRDept.trim(); 
            item.requesterInfo.team = ''; // íŒ€ì€ ë¹ˆ ê°’ìœ¼ë¡œ ì €ì¥
            
            // ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸: 'ìœ ì§€'ê°€ ì•„ë‹ˆë©´ì„œ ê³µë°±ì´ ì•„ë‹ ê²½ìš° ì²« ë²ˆì§¸ URLë§Œ ì—…ë°ì´íŠ¸
            if (newMainImageUrl !== 'ìœ ì§€' && newMainImageUrl.trim() !== currentMainImageUrl && newMainImageUrl.trim() !== 'ì—†ìŒ') {
                 // ê¸°ì¡´ ë°°ì—´ì„ ìœ ì§€í•˜ë©´ì„œ ì²« ë²ˆì§¸ ìš”ì†Œë§Œ ì—…ë°ì´íŠ¸
                 item.imageUrls = [newMainImageUrl.trim(), ...item.imageUrls.slice(1)].filter(url => url.trim() !== '');
                 if(item.imageUrls.length === 0) item.imageUrls = []; // ëª¨ë‘ ë¹ˆ ë¬¸ìì—´ì¼ ê²½ìš° ë¹ˆ ë°°ì—´ë¡œ
            }


            alert(`ë¬¼í’ˆ [${item.name}]ì˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            showPage('main');
        }

        // ========== ê´€ë¦¬ì ì•¡ì…˜ êµ¬í˜„ ==========
        function approveItem(itemId){ const idx = items.findIndex(i=>i.id===itemId); if(idx<0) return; const it = items[idx]; if(!checkAdminAuth(it,'register_approve')){ alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); return } it.status='íŒë§¤ ì¤‘'; it.registerDate = getTodayDate(); alert(`ë¬¼í’ˆ [${it.name}] ë“±ë¡ì´ ìŠ¹ì¸ë˜ì–´ 'íŒë§¤ ì¤‘' ìƒíƒœê°€ ë©ë‹ˆë‹¤.`); renderAdminList(); showPage('main'); }
        function deleteItem(itemId){ const idx = items.findIndex(i=>i.id===itemId); if(idx<0) return; const it=items[idx]; if(!isAdmin || adminDept!==it.requesterInfo.dept){ if(!confirm('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ì–´ë„ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í• ê¹Œìš”?')) return; }
            if(!confirm(`ë¬¼í’ˆ [${it.name}]ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return; items.splice(idx,1); alert('ì‚­ì œ ì™„ë£Œ'); renderAdminList(); showPage('main'); }
        function approveTrade(itemId){ const it = items.find(i=>i.id===itemId); if(!it) return; if(!checkAdminAuth(it,'trade_approve')){ alert('ê¶Œí•œ ì—†ìŒ'); return } it.historyStatus='ì˜ˆì•½ ìŠ¹ì¸'; // 1ì°¨ -> 2ì°¨ ëŒ€ê¸°
            alert(`ì‹ ì²­ ìŠ¹ì¸ ì™„ë£Œ. ì‹ ì²­ì ë¶€ì„œ(${it.historyBuyerInfo?it.historyBuyerInfo.dept:'-'})ì˜ ê´€ë¦¬ì í™•ì¸ ëŒ€ê¸°`); renderAdminList(); showPage('main'); }
        function cancelTradeByAdmin(itemId){ const it = items.find(i=>i.id===itemId); if(!it) return; if(!isAdmin){ alert('ê´€ë¦¬ì ê¶Œí•œ í•„ìš”'); return } // ê¶Œí•œ ì²´í¬ëŠ” ìƒí™©ì— ë”°ë¼ ì´ë¯¸ ì ìš©ëœ ë²„íŠ¼ë§Œ í‘œì‹œë¨
            it.status='íŒë§¤ ì¤‘'; it.historyStatus='ì‹ ì²­ ì—†ìŒ'; it.historyBuyerInfo=null; alert('ì˜ˆì•½/ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'); renderAdminList(); showPage('main'); }
        function confirmTrade(itemId){ const it = items.find(i=>i.id===itemId); if(!it) return; if(!checkAdminAuth(it,'trade_confirm')){ alert('ê¶Œí•œ ì—†ìŒ'); return } it.status='ê±°ë˜ ì™„ë£Œ'; it.historyStatus='ê±°ë˜ í™•ì •'; alert(`ë¬¼í’ˆ [${it.name}] ê±°ë˜ê°€ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`); renderAdminList(); showPage('main'); }

        // ========== ì‹ ì²­ ì²˜ë¦¬ ==========
        function renderItemDetailPage(itemId){ 
            const item = items.find(i=>i.id===itemId); 
            const detailPage = document.getElementById('itemDetailPage'); 
            currentItemId=itemId; 
            if(!item || item.status!=='íŒë§¤ ì¤‘'){ detailPage.innerHTML=`<h3>ğŸš« ë‚˜ëˆ” ì‹ ì²­ ë¶ˆê°€</h3><p>ì´ ë¬¼í’ˆì€ í˜„ì¬ ì‹ ì²­ ê°€ëŠ¥í•œ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.</p><button class="cancel-btn" onclick="showPage('main')">ğŸ”™ ë’¤ë¡œê°€ê¸°</button>`; return }
            
            // ğŸ› ï¸ ë³€ê²½: ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ëŒ€í‘œ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©
            const firstImageUrl = getDisplayImage(item, 0);
            const isNoImage = firstImageUrl === null; 
            const displayImageUrl = isNoImage?NO_IMAGE_PLACEHOLDER:firstImageUrl; 
            // ì‹ ì²­ í˜ì´ì§€ì—ì„œëŠ” ì´ë¯¸ì§€ë¥¼ í´ë¦­í•´ë„ í™•ëŒ€ ê¸°ëŠ¥ì„ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            const imageHtml = isNoImage?`<div class="image-container" style="height:150px;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-weight:700">${NO_IMAGE_TEXT}</div>`:`<div class="image-container"><img src="${displayImageUrl}" alt="${item.name}"></div>`;
            
            renderDeptSelect('applyDept');
            // ë‚˜ëˆ” ì‹ ì²­ í¼ì—ì„œ 'íŒ€' í•„ë“œ ì œê±° ë° ì´ë¦„ placeholder ë³€ê²½
            detailPage.innerHTML = `<h3>â­ ë‚˜ëˆ” ì‹ ì²­: ${item.name}</h3><div class="item-detail-info" style="display:flex;gap:16px;margin-top:12px">${imageHtml}<div class="text-content"><h2 style="margin:0">${item.name}</h2><p style="white-space:pre-wrap">${item.description}</p><strong>ì¹´í…Œê³ ë¦¬: ${item.category||'ë¯¸ë¶„ë¥˜'}</strong><strong style="display:block;margin-top:6px">ë“±ë¡ì¼: ${item.registerDate||'-'}</strong></div></div><div style="margin-top:14px;padding:12px;border:2px solid var(--success);border-radius:10px;background:#f0fff0"><h4 style="margin:0 0 8px">ğŸ“ ì‹ ì²­ì ì •ë³´ ì…ë ¥</h4><p style="margin:0 0 8px">ì•„ë˜ ì •ë³´ ì…ë ¥ í›„ ë‚˜ëˆ”ì‹ ì²­ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. <br>ë‹´ë‹¹ì ìŠ¹ì¸ í›„ ì—°ë½ ì˜ˆì •ì…ë‹ˆë‹¤.</p><div class="info-group" style="margin-top:8px"><input type="text" id="applyName" placeholder="ì´ë¦„+ì•ŒíŒŒë²³ (ì˜ˆ: ê¹€ë‚˜ëˆ”a)"><select id="applyDept"></select></div><div style="margin-top:12px"><button class="primary" onclick="submitTradeApplication()">ë‚˜ëˆ” ì‹ ì²­</button> <button class="cancel-btn" onclick="showPage('main')">ğŸ”™ ë’¤ë¡œê°€ê¸°</button></div></div>`; renderDeptSelect('applyDept'); 
        }

        function submitTradeApplication(){ 
            const item = items.find(i=>i.id===currentItemId); 
            if(!item || item.status!=='íŒë§¤ ì¤‘'){ alert('ì‹ ì²­í•  ìˆ˜ ì—†ëŠ” ë¬¼í’ˆì…ë‹ˆë‹¤.'); showPage('main'); return }
            
            // 'íŒ€' í•„ë“œ ì œê±° ë°˜ì˜
            const applyInfo = { 
                name: (document.getElementById('applyName').value||'').trim(), 
                dept: document.getElementById('applyDept').value, 
                team: '', // 'íŒ€'ì€ ë¹ˆ ê°’ìœ¼ë¡œ ì €ì¥
                id: '' 
            };
            
            // 'íŒ€' ìœ íš¨ì„± ê²€ì‚¬ ì œê±° ë°˜ì˜
            if(!applyInfo.name||!applyInfo.dept){ alert('ì´ë¦„ê³¼ ë¶€ì„œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return }

            item.status='ì˜ˆì•½ì¤‘'; item.historyStatus='ì‹ ì²­ ì¤‘'; item.historyBuyerInfo=applyInfo; alert(`ë¬¼í’ˆ [${item.name}] ë‚˜ëˆ” ì‹ ì²­ ì™„ë£Œ. ë‹´ë‹¹ì ìŠ¹ì¸ í›„ ì—°ë½ ì˜ˆì •ì…ë‹ˆë‹¤..`); showPage('main'); 
        }

        // ========== íŒŒì¼ ì—…ë¡œë“œ & ë“±ë¡ ìš”ì²­ ì²˜ë¦¬ ==========
        
        // ğŸ› ï¸ ë³€ê²½: ë©€í‹° íŒŒì¼ ì²˜ë¦¬ ë° ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§ ì—…ë°ì´íŠ¸
        async function addItemAsync(){
            const name = (document.getElementById('itemName').value||'').trim(); 
            const rName=(document.getElementById('requesterName').value||'').trim(); 
            const rDept=document.getElementById('requesterDept').value; 
            const rId = ''; 
            const category=document.getElementById('itemCategory').value; 
            const description=(document.getElementById('itemDescription').value||'').trim(); 
            
            // ğŸ› ï¸ ë³€ê²½: ë‹¤ì¤‘ íŒŒì¼ ì…ë ¥ í•„ë“œ ID ì‚¬ìš©
            const files = document.getElementById('itemImageFiles').files;
            
            if(!name||!description||!category||!rName||!rDept){ 
                alert('ë¬¼í’ˆ ì´ë¦„, ë“±ë¡ì ì •ë³´(ì´ë¦„, ë¶€ì„œ), ì¹´í…Œê³ ë¦¬, ìƒì„¸ ì„¤ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); 
                return 
            }

            // íŒŒì¼ ê°œìˆ˜ ìœ íš¨ì„± ê²€ì‚¬ (1~3ì¥)
            if (files.length === 0) {
                alert('ë¬¼í’ˆ ì‚¬ì§„ì„ ìµœì†Œ 1ì¥ ì´ìƒ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (files.length > 3) {
                alert('ë¬¼í’ˆ ì‚¬ì§„ì€ ìµœëŒ€ 3ì¥ê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤. 3ì¥ ì´í•˜ë¡œ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            let imageUrls = []; // ë°°ì—´ë¡œ Base64 ë¬¸ìì—´ ì €ì¥
            try{ 
                // ëª¨ë“  íŒŒì¼ì„ Base64ë¡œ ë³€í™˜ (5MB ì œí•œ ì ìš©ë¨)
                const conversionPromises = Array.from(files).map(file => convertFileToBase64(file));
                imageUrls = await Promise.all(conversionPromises);
                imageUrls = imageUrls.filter(url => url && url.trim() !== ''); // ë¹ˆ ë¬¸ìì—´ ì œê±°
            }catch(err){ 
                console.error('íŒŒì¼ ë³€í™˜ ì˜¤ë¥˜',err); 
                // 5MB ì œí•œ ë°˜ì˜ëœ ì—ëŸ¬ ë©”ì‹œì§€
                alert(`ì´ë¯¸ì§€ íŒŒì¼ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ë‹¹ ìµœëŒ€ 5MB ì´í•˜ë¡œ ì‹œë„í•´ ì£¼ì„¸ìš”. (${err.message})`); 
                return 
            }
            
            const newId = items.reduce((m,i)=>Math.max(m,i.id),0)+1;
            
            // ğŸ› ï¸ ë³€ê²½: imageUrl -> imageUrls ë°°ì—´ ì €ì¥
            const newItem = { 
                id:newId, name, status:'ìŠ¹ì¸ ëŒ€ê¸°', description, 
                imageUrls: imageUrls, 
                historyStatus:'ì‹ ì²­ ì—†ìŒ', category, 
                requesterInfo:{name:rName,dept:rDept,team:'',id:rId}, 
                historyBuyerInfo:null, registerDate:getTodayDate() 
            };
            
            items.unshift(newItem); 
            alert(`ë¬¼í’ˆ ë“±ë¡ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì˜ ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœì…ë‹ˆë‹¤. (id:${newId})`);
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('itemName').value=''; 
            document.getElementById('requesterName').value=''; 
            document.getElementById('requesterDept').value=''; 
            document.getElementById('itemCategory').value=''; 
            document.getElementById('itemDescription').value=''; 
            // ğŸ› ï¸ ë³€ê²½: íŒŒì¼ ì…ë ¥ í•„ë“œ ID
            document.getElementById('itemImageFiles').value='';
            
            showPage('main');
        }

        // ========== ì´ˆê¸° ì´ë²¤íŠ¸ ë°”ì¸ë”© ë° ì‹œì‘ ==========
        document.getElementById('searchInput').addEventListener('input',()=>{ 
            const v=document.getElementById('searchInput').value; 
            document.getElementById('clearSearchBtn').style.display = v.trim()? 'inline-block':'none'; 
            searchItems(); 
        });

        // ì´ˆê¸°í™”
        window.onload = ()=>{ 
            showPage('main'); 
            renderCategoryGrid(); 
            renderCategorySelect(); 
            renderDeptSelect('requesterDept'); 
        }

    </script>
</body>
</html>